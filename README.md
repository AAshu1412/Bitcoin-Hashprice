# ⚡ Bitcoin Hashprice API Server

<div align="center">

![Build Status](https://img.shields.io/badge/build-passing-brightgreen)
![Version](https://img.shields.io/badge/version-1.0.0-blue)
![License](https://img.shields.io/badge/license-MIT-yellow)
![Node.js](https://img.shields.io/badge/Node.js-18.x+-green?logo=node.js)
![Express](https://img.shields.io/badge/Express-4.x-blue?logo=express)
![MongoDB](https://img.shields.io/badge/MongoDB-Optimized-green?logo=mongodb)

**A high-performance, caching-first Node.js server for calculating Bitcoin hashprice in real-time.**

</div>

---

> 💡 **What is Hashprice?** Hashprice represents the expected revenue a Bitcoin miner can earn per unit of hashrate per day, calculated in **BTC per Petahash (PH) per day**.

This project provides a robust API to calculate the current Bitcoin hashprice by analyzing recent block rewards (subsidy + fees) and current network hashrate. It is built for speed and efficiency, using **MongoDB as a powerful caching and aggregation layer** to minimize external API calls and deliver millisecond response times for cached data.

## 📋 Table of Contents

- [📈 The Hashprice Calculation](#-the-hashprice-calculation)
- [✨ Features](#-features)
- [🚀 Performance & Architecture](#-performance--architecture-why-mongodb)
- [🛠️ Tech Stack](#️-tech-stack)
- [🏁 Getting Started](#-getting-started)
- [🔌 API Endpoints](#-api-endpoints)
- [📊 API Reference](#-api-reference)

---

## 📈 The Hashprice Calculation

**Hashprice** is the expected revenue a Bitcoin miner can earn per unit of hashrate, per day. This API calculates it in **BTC per Petahash (PH) per day**.

The core calculation is based on the total daily revenue generated by the network, divided by the network's total hashrate.

### The Formula

1.  First, we determine the average revenue generated by a single block. This is the sum of the fixed block subsidy (e.g., 3.125 BTC) and the average transaction fees from a sample of recent blocks.
    $$
    \text{Revenue}_{\text{block}} = \text{Block Subsidy}_{\text{BTC}} + \text{Average Tx Fees}_{\text{BTC}}
    $$

2.  Next, we calculate the total estimated revenue generated by the entire network in one day (assuming 144 blocks per day).
    $$
    \text{Total Daily Revenue} = \text{Revenue}_{\text{block}} \times 144
    $$

3.  Finally, we divide this total daily revenue by the current network hashrate (in Petahashes per second) to get the daily revenue per Petahash.

    $$
    \text{Hashprice (BTC/PH/day)} = \frac{(\text{Avg. Block Subsidy} + \text{Avg. Tx Fees}) \times 144}{\text{Network Hashrate (PH/s)}}
    $$

---

## ✨ Features

<table>
<tr>
<td width="50%">

### 🚀 **Performance**
- **Real-time Hashprice:** Calculates `BTC/PH/day` using the latest block data
- **Intelligent Block Caching:** Uses MongoDB to store block data. When a request is made, it only fetches blocks *missing* from the cache, dramatically reducing latency and external API calls
- **High-Speed Aggregation:** Leverages MongoDB's aggregation pipeline to calculate average fees across 144+ blocks in a single, fast database operation

</td>
<td width="50%">

### 📊 **Analytics & Monitoring**
- **Performance Tracking:** A built-in system monitors the performance of API calls, block processing, and database operations, storing metrics in a dedicated collection
- **Advanced Analytics:** Provides endpoints to analyze block utilization, fee trends, and transaction patterns
- **Durable & Optimized:** Uses modern `async/await`, efficient `bulkWrite` operations, and TTL (Time-To-Live) indexes for automatic data cleanup

</td>
</tr>
</table>

---

## 🚀 Performance & Architecture (Why MongoDB?)

> 🎯 **This project is a hashprice calculator first**. The choice of MongoDB is a deliberate **performance strategy**, not the focus of the project itself.

A traditional relational (SQL) database would be highly inefficient for this use case. Here's why this architecture is faster:

### 🔥 **Performance Advantages**

<table>
<tr>
<td width="25%">

#### 🧠 **Intelligent Caching**
Instead of re-fetching 144 blocks from the `blockchain.info` API on every request (which would be slow and rate-limit-prone), we store fetched blocks as documents. The server intelligently finds which blocks it's missing and fetches *only* those.

</td>
<td width="25%">

#### ⚡ **Powerful Aggregations**
Calculating average fees across 144 blocks is done with a **single, highly-optimized MongoDB aggregation pipeline** (`$group`, `$avg`). A SQL equivalent would involve querying 144 rows (or a complex `JOIN`) and computing the average in-app, which is much slower.

</td>
<td width="25%">

#### 📦 **Embedded Data**
Storing block fee statistics (`fee_stats`) and analytics (`analytics`) within the block document simplifies queries and avoids the costly `JOIN` operations inherent in a normalized SQL design.

</td>
<td width="25%">

#### 🧹 **Automatic Cleanup**
**TTL (Time-To-Live) indexes** are used to automatically purge old data (like block data older than 7 days or performance logs older than 30 days). This provides zero-maintenance data cleanup, which is a manual task in most SQL systems.

</td>
</tr>
</table>

<div align="center">

### 🎉 **The Result**

**Cached hashprice requests are served in milliseconds** ⚡  
Fresh calculations are optimized by only fetching the absolute minimum data required 🚀

</div>

---

## 🛠️ Tech Stack

<div align="center">

| Category | Technology | Purpose |
|----------|------------|---------|
| 🟢 **Runtime** | Node.js | JavaScript runtime environment |
| 🌐 **Server** | Express.js | Web application framework |
| 🗄️ **Database** | MongoDB | High-speed caching, aggregation, and analytics |
| 📡 **HTTP Client** | `node-fetch` | API data fetching |
| ⚙️ **Configuration** | `dotenv` | Environment variable management |

</div>

---

## 🏁 Getting Started

### 📋 Prerequisites

<div align="center">

| Requirement | Version | Download |
|-------------|---------|----------|
| 🟢 **Node.js** | v18+ | [Download](https://nodejs.org/) |
| 🗄️ **MongoDB** | Latest | [Download](https://www.mongodb.com/try/download/community) |

</div>

> 💡 **Tip:** You can use either a local MongoDB instance or a free [MongoDB Atlas](https://www.mongodb.com/atlas) cluster.

### 🚀 Quick Setup

#### 1️⃣ **Clone & Install**

```bash
# Clone the repository
git clone https://github.com/your-username/your-repo-name.git
cd your-repo-name

# Install dependencies
npm install
```

#### 2️⃣ **Configure Environment**

Create a `.env` file in the project root:

```env
# Local MongoDB instance
MONGODB_URI=mongodb://localhost:27017

# MongoDB Atlas cluster (uncomment and configure)
# MONGODB_URI=mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/bitcoin_hashprice?retryWrites=true&w=majority

# Optional: Custom port
PORT=3000
```

#### 3️⃣ **Start the Server**

```bash
npm start
```

### 🎉 **Success!**

You should see output like this:

```
🔧 Server starting with config: {...}
📊 Connecting to MongoDB...
✅ Connected to MongoDB
🏗️ Setting up collections and indexes...
✅ MongoDB indexes created successfully
🚀 Server running on port 3000
📡 Endpoints:
   - Hashprice: http://localhost:3000/hashprice-btc
   - Performance: http://localhost:3000/performance-metrics
   ...
```

<div align="center">

### 🧪 **Test Your Setup**

```bash
curl http://localhost:3000/hashprice-btc
```

</div>

---

## 🔌 API Endpoints

<div align="center">

### 🎯 **Core Hashprice**

| Endpoint | Method | Description | Status |
|----------|--------|-------------|--------|
| `/hashprice-btc` | `GET` | Calculates the hashprice using cached data | ✅ Active |

</div>

### 📊 **Performance & Analytics**

<table>
<tr>
<td width="33%">

#### 🔍 **Monitoring**
- `/performance-metrics` - Raw performance logs and aggregated stats
- `/performance-comparison` - Performance trends over time
- `/latest-performance` - Most recent request metrics

</td>
<td width="33%">

#### 📈 **Analytics**
- `/blocks/analytics` - Block fee trends and transaction patterns
- `/performance-showcase` - Cache efficiency breakdown
- `/performance-summary` - Top-level summary of all requests

</td>
<td width="33%">

#### ⚡ **Comparison**
- `/mongodb-vs-sql` - Real-time MongoDB vs SQL comparison

</td>
</tr>
</table>

---

## 📊 API Reference

### 🎯 **GET /hashprice-btc**

> 💡 **Primary endpoint** for calculating Bitcoin hashprice using cached data for optimal performance.

#### 📋 **Query Parameters**

<div align="center">

| Parameter | Type | Required | Default | Max | Description |
|-----------|------|----------|---------|-----|-------------|
| `n` | `number` | ❌ No | `144` | `288` | Number of recent blocks to sample for calculating average fees |
| `subsidy` | `number` | ❌ No | `3.125` | - | Manually override the current block subsidy (in BTC) |

</div>

#### 🚀 **Usage Examples**

```bash
# Default calculation (144 blocks)
curl http://localhost:3000/hashprice-btc

# Sample last 72 blocks
curl http://localhost:3000/hashprice-btc?n=72

# Override subsidy
curl http://localhost:3000/hashprice-btc?subsidy=3.125

# Combined parameters
curl http://localhost:3000/hashprice-btc?n=72&subsidy=3.125
```

#### 📤 **Response Example**

```json
{
  "unit": "BTC/PH/day",
  "hashprice": 0.0000045123,
  "components": {
    "blocksSampled": 144,
    "subsidyBTCPerBlock": 3.125,
    "estFees144BTC": 25.81,
    "networkRevenueBTCPerDay": 475.81,
    "networkHashratePHs": 105445.67,
    "advanced_stats": {
      "/* ... detailed fee and block stats ... */"
    }
  },
  "performance": {
    "request_duration_ms": 12,
    "data_source": "mongodb_optimized",
    "cached": true
  }
}
```

<div align="center">

### 🎉 **Response Fields**

| Field | Type | Description |
|-------|------|-------------|
| `unit` | `string` | Unit of measurement: "BTC/PH/day" |
| `hashprice` | `number` | Calculated hashprice value |
| `components` | `object` | Detailed calculation breakdown |
| `performance` | `object` | Request performance metrics |

</div>

---

## 🔍 **Performance Endpoints**

<div align="center">

### 📊 **Monitoring & Analytics**

</div>

<table>
<tr>
<td width="50%">

### 🔍 **Monitoring**

#### **GET /performance-metrics**
Shows raw performance logs and aggregated stats (avg duration, success rate) for internal operations.

#### **GET /performance-comparison**
Shows performance trends over time and metrics on MongoDB's efficiency.

#### **GET /latest-performance**
Returns the performance metrics for the single most recent `/hashprice-btc` request.

</td>
<td width="50%">

### 📈 **Analytics**

#### **GET /blocks/analytics**
Provides analytics on block fee trends, utilization, and transaction patterns from the cached block data.

#### **GET /performance-showcase**
A detailed breakdown of cache efficiency, including hit rate, performance improvement vs. cold cache, and estimated API/bandwidth savings.

#### **GET /performance-summary**
A top-level summary of all hashprice calculation requests, showing cache hit rate, avg response times, and performance grades.

#### **GET /mongodb-vs-sql**
A real-time comparison of the MongoDB architecture vs. a hypothetical SQL equivalent, quantifying the performance gains.

</td>
</tr>
</table>

---

<div align="center">

## 🎉 **Ready to Get Started?**

[![Deploy](https://img.shields.io/badge/Deploy-Ready-brightgreen?style=for-the-badge)](https://github.com/your-username/your-repo-name)
[![Documentation](https://img.shields.io/badge/Documentation-Complete-blue?style=for-the-badge)](https://github.com/your-username/your-repo-name#readme)
[![Performance](https://img.shields.io/badge/Performance-Optimized-orange?style=for-the-badge)](https://github.com/your-username/your-repo-name)

**Built with ❤️ for the Bitcoin community**

</div>
